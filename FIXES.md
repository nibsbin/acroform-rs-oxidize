# Bug Fixes and Issues

## PDF 1.5+ Field Update Support

### Issue
When running the `simple_fill` example on `af8_error.pdf` (PDF 1.6) or other PDF 1.5+ files, field updates were not being written correctly. The library would appear to succeed, but when inspecting the output PDF with qpdf, the field values remained unchanged.

### Investigation with qpdf
Using qpdf to investigate the issue revealed:
1. The updated field object was being written to the PDF as a new object (e.g., object 1094)
2. The cross-reference (xref) table entry for the original object (e.g., object 248) was not updated
3. The original object was stored in a compressed object stream (XRef::Stream), a space-saving feature introduced in PDF 1.5
4. The xref entry for the original object still pointed to the compressed stream instead of the new uncompressed object

### Root Cause
PDF 1.5 introduced compressed object streams where multiple objects are stored together in a compressed format. In the codebase, these are represented by `XRef::Stream` entries in the cross-reference table.

The `update()` method in `pdf/src/file.rs` was calling `create()` when it encountered an object stored in a compressed stream:

```rust
XRef::Stream { .. } => return self.create(obj),
```

This would create a new object with a new ID, leaving the original object's xref entry unchanged. When PDF readers looked up the original object ID, they would still find the old compressed version.

### Solution
Modified the `update()` method to properly handle objects in compressed streams by:
1. Extracting the object from the compressed stream
2. Writing it as a regular uncompressed object with the **same** object ID
3. Updating the xref entry to point to the new uncompressed location

Changed code:
```rust
// For objects in compressed streams (PDF 1.5+), we need to extract them
// and write them as regular objects. Use generation 0 for these.
XRef::Stream { .. } => PlainRef { id: old.id, gen: 0 },
```

This ensures the updated object is written with the original object ID, and the xref entry is properly updated to point to it.

### Changes Made
1. **pdf/src/file.rs**:
   - Modified the `update()` method to handle `XRef::Stream` case by extracting and writing as uncompressed object with same ID
   - Added documentation explaining the PDF 1.5+ compressed stream handling

2. **acroform/examples/simple_fill.rs**:
   - Fixed field name to match the actual field structure: `P[0].Page1[0].topmostSubform[0].MbrName[1]`

3. **acroform/tests/pdf_15_plus_test.rs** (NEW):
   - Added comprehensive tests for PDF 1.6 support
   - Added tests for PDF 1.7 support
   - Added backward compatibility tests for PDF 1.3
   - Tests verify that field updates work correctly across all PDF versions

### Testing
- ✅ `simple_fill` example now successfully writes "NEW_VALUE" to `af8_error.pdf` (PDF 1.6)
- ✅ Field updates verified with qpdf showing correct values in output PDF
- ✅ All existing tests pass (12 total: 8 integration + 1 widget annotation + 3 PDF version tests)
- ✅ Tested with PDF 1.3, 1.6, and 1.7 files - all work correctly
- ✅ Backward compatibility maintained for older PDFs without compressed streams

### Impact
This fix enables the library to properly update form fields in modern PDFs (version 1.5+) that use compressed object streams, significantly improving compatibility with PDFs generated by contemporary tools.

---

## af8_error.pdf - Appearance Stream Parsing Error

### Issue
When running the `simple_fill` example on `af8_error.pdf`, the following error occurred:

```
Error: Shared { source: FromPrimitive { typ: "Option < MaybeRef < AppearanceStreams > >", 
field: "appearance_streams", source: FromPrimitive { typ: "Ref < AppearanceStreamEntry >", 
field: "normal", source: UnexpectedPrimitive { expected: "Reference", found: "Dictionary" } } } }
```

### Root Cause
The `AppearanceStreams` struct in `pdf/src/object/types.rs` defined the `normal`, `rollover`, and `down` fields as `Ref<AppearanceStreamEntry>`, which only accepts indirect object references. However, according to the PDF specification (section 12.5.5), appearance streams can be either:
- Direct objects (embedded dictionaries)
- Indirect objects (referenced via object reference)

The `af8_error.pdf` file contains appearance streams as direct dictionary objects rather than indirect references, causing the parser to fail when it encountered a Dictionary primitive instead of a Reference.

### Solution
Changed the field types in `AppearanceStreams` from `Ref<AppearanceStreamEntry>` to `MaybeRef<AppearanceStreamEntry>`. The `MaybeRef<T>` type is an enum that can handle both:
- `Direct(Shared<T>)` - for direct objects embedded in the parent
- `Indirect(RcRef<T>)` - for indirect objects referenced by ID

This is consistent with how other similar fields are defined, such as `default_resources: Option<MaybeRef<Resources>>`.

### Changes Made
1. **pdf/src/object/types.rs**:
   - Changed `normal: Ref<AppearanceStreamEntry>` to `normal: MaybeRef<AppearanceStreamEntry>`
   - Changed `rollover: Option<Ref<AppearanceStreamEntry>>` to `rollover: Option<MaybeRef<AppearanceStreamEntry>>`
   - Changed `down: Option<Ref<AppearanceStreamEntry>>` to `down: Option<MaybeRef<AppearanceStreamEntry>>`
   - Added documentation explaining the rationale

2. **examples/src/bin/form.rs**:
   - Updated to use `MaybeRef` API:
     - Access data via dereference: `**a.normal`
     - Get reference for updates: `a.normal.as_ref()`

### Testing
- ✅ `simple_fill` example now successfully processes `af8_error.pdf`
- ✅ `in_memory_fill` example works correctly
- ✅ All existing tests pass (43 tests total)
- ✅ No regressions with other PDF files (`af8.pdf`, `af8_clean.pdf`)

### Impact
This fix allows the library to handle a wider variety of PDF files that use different encoding strategies for appearance streams, improving compatibility with PDF files generated by various tools.
