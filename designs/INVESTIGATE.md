# Investigation: Blank NEW_VALUE Field in PDF Viewers

## Problem Statement
The `simple_fill` example updates the field `P[0].Page1[0].topmostSubform[0].MbrName[1]` from `OLD_VALUE` to `NEW_VALUE` in the PDF form. However, when opening the resulting PDF in certain viewers (particularly browsers), the field appears blank or shows the old template value instead of `NEW_VALUE`.

## Investigation Method
Used `qpdf` version 11.9.0 to analyze the PDF structure of the filled form (`/tmp/af8_filled.pdf`) generated by the `simple_fill` example.

## Key Findings

### 1. Field Value vs. Appearance Stream Mismatch

The core issue is a **mismatch between the field's value and its appearance stream**.

#### Field Value (/V) - Correctly Updated
```
qpdf --show-object=248 /tmp/af8_filled.pdf
```

Output shows the /V (value) field has been correctly updated:
```
/V <feff004e00450057005f00560041004c00550045>
```
This is the UTF-16BE encoding of "NEW_VALUE" (with BOM prefix `feff`).

Also visible in the qpdf JSON output:
```json
{
  "value": "u:NEW_VALUE",
  "defaultvalue": "u:OLD_VALUE"
}
```

#### Appearance Stream (/AP) - NOT Updated
```
qpdf --show-object=111 --filtered-stream-data /tmp/af8_filled.pdf
```

The appearance stream still contains the **original template value**:
```
/Tx BMC 
q
0 0 239.204 10.731 re
W
n
BT
/TimesNewRomanPSMT 10 Tf
0 g
0 2.889 Td
({{examinee.last}}, ) Tj
78.896 0 Td
({{examinee.first}}{%if ) Tj
97.857 0 Td
(examinee.middle ) Tj
71.084 0 Td
(%}, ) Tj
-247.837 -12 Td
({{examinee.middle}}{%endif%}) Tj
ET
Q
EMC
```

The appearance stream displays template syntax like `{{examinee.last}}` instead of the new value "NEW_VALUE".

### 2. PDF Viewer Behavior

Different PDF viewers handle this situation differently:

- **Adobe Acrobat/Reader**: These viewers typically **ignore** outdated appearance streams when field values don't match, and **regenerate** the appearance from the field value (/V). This is why the form works correctly in Adobe products.

- **Browser PDF Viewers (Chrome, Firefox, Safari)**: These viewers **rely primarily on the appearance stream** (/AP) for rendering form fields. When the appearance stream is missing or doesn't match the value, they often:
  - Display the appearance stream content (template syntax)
  - Display nothing (blank)
  - Show the field as non-editable

### 3. Missing /NeedAppearances Flag

The filled PDF does not contain the `/NeedAppearances` flag in the AcroForm dictionary:

```
qpdf --show-object=1025 /tmp/af8_filled.pdf
<< /DA (/Helv 0 Tf 0 g ) /DR << ... >> /Fields [ 244 0 R ] /SigFlags 1 >>
```

The `/NeedAppearances true` flag, when present, instructs PDF viewers to regenerate appearance streams from field values. However, not all viewers respect this flag (browser viewers often ignore it).

### 4. Field Hierarchy Verification

The field is properly connected in the form hierarchy:
- AcroForm → Fields: [244 0 R]
- 244 0 R (topmostSubform[0]) → Kids: [245 0 R, 243 0 R]
- 245 0 R (Page1[0]) → Kids: [246 0 R]
- 246 0 R (P[0]) → Kids: [247 0 R, **248 0 R**, ...]

Note: `qpdf` does issue a warning about object 248 0 R:
```
WARNING: this widget annotation is not reachable from /AcroForm in the document catalog
```

However, manual verification shows the field IS reachable through the parent/child hierarchy. This warning may be a false positive or indicate a subtle structural issue that doesn't affect Adobe readers but might affect other viewers.

## Root Cause

**The acroform-rs library updates the field value (/V) but does not regenerate the appearance stream (/AP) to match.**

When a PDF form field's value is changed, the appearance stream must be either:
1. **Regenerated** to display the new value, OR
2. **Removed** (with `/NeedAppearances true` set to tell viewers to generate it)

The current implementation does neither, leaving an outdated appearance stream that doesn't match the new field value.

## Recommended Solutions

### Option 1: Set /NeedAppearances Flag (Partial Solution)
Add `/NeedAppearances true` to the AcroForm dictionary. This tells PDF viewers that appearance streams need to be regenerated.

**Pros:**
- Simple to implement
- Works with Adobe Acrobat and some other viewers

**Cons:**
- Many browser PDF viewers ignore this flag
- Not a complete solution for web-based forms

### Option 2: Remove Appearance Streams (Better)
When updating a field value, remove its appearance stream (/AP entry). Combined with `/NeedAppearances true`, this forces viewers to generate the appearance from the field value.

**Pros:**
- More reliable than just setting the flag
- Works with more viewers

**Cons:**
- Still relies on viewer cooperation
- Some viewers may show blank fields

### Option 3: Regenerate Appearance Streams (Best)
Generate proper appearance streams that display the new field values using PDF text drawing operators.

**Pros:**
- Maximum compatibility across all PDF viewers
- Fields display correctly everywhere
- Professional-grade solution

**Cons:**
- Most complex to implement
- Requires understanding of:
  - PDF text drawing operators
  - Font metrics and text positioning
  - Appearance stream format
  - Field rectangle dimensions

## Technical Details

### Appearance Stream Format
An appearance stream is an XObject Form that contains drawing commands to render the field's visual appearance:

```
/Tx BMC                          % Begin marked content for text field
q                                % Save graphics state
0 0 width height re              % Define clipping rectangle
W n                              % Set clipping path
BT                               % Begin text object
/FontName size Tf                % Set font and size
0 g                              % Set color (black)
x y Td                           % Position cursor
(Text to display) Tj             % Show text string
ET                               % End text object
Q                                % Restore graphics state
EMC                              % End marked content
```

### Field Value Encoding
Field values can be stored as:
- Plain text string: `(NEW_VALUE)`
- UTF-16BE with BOM: `<feff004e00450057005f00560041004c00550045>`

The library correctly uses UTF-16BE encoding for the value.

## How Other PDF Libraries Handle This

### iText (Java)
- Automatically regenerates appearance streams when field values change
- Sets `/NeedAppearances false` after generating appearances
- Ensures compatibility across all viewers

### PyPDF2/pypdf (Python)
- Offers `need_appearances` parameter
- Can remove appearance streams and set `/NeedAppearances true`
- Relies on viewer to regenerate

### PDF-lib (JavaScript)
- Provides `form.flatten()` to "burn in" field values as content
- Can generate appearance streams
- Offers both approaches

### pdftk (Command-line)
- Sets `/NeedAppearances true` by default
- Can flatten forms to ensure display
- Simple but effective approach

## Reproduction Steps

1. Build and run the simple_fill example:
   ```bash
   cargo run --example simple_fill
   ```

2. Examine the output PDF:
   ```bash
   # Check the field value (correctly set to NEW_VALUE)
   qpdf --show-object=248 /tmp/af8_filled.pdf | grep "/V"
   
   # Check the appearance stream (still shows template)
   qpdf --show-object=111 --filtered-stream-data /tmp/af8_filled.pdf
   ```

3. Open `/tmp/af8_filled.pdf` in:
   - Adobe Acrobat Reader: Field displays "NEW_VALUE" ✓
   - Chrome browser: Field may appear blank or show template ✗
   - Firefox browser: Field may appear blank or show template ✗

## Conclusion

The issue is **not a bug in the library's value-setting logic**, but rather a **missing feature**: appearance stream management. The library successfully updates field values, but doesn't handle the visual representation that most PDF viewers (especially browsers) rely on for display.

To make filled PDFs work reliably across all viewers, the library needs to implement appearance stream regeneration or at minimum set the `/NeedAppearances` flag and remove outdated appearance streams.

## Quick Reference: qpdf Investigation Commands

```bash
# Generate the filled PDF
cargo run --example simple_fill

# Check PDF structure and validity
qpdf --check /tmp/af8_filled.pdf

# Get comprehensive JSON structure with warnings
qpdf --json /tmp/af8_filled.pdf > filled_structure.json

# Examine specific objects
qpdf --show-object=248 /tmp/af8_filled.pdf          # Field object
qpdf --show-object=110 /tmp/af8_filled.pdf          # Appearance dictionary
qpdf --show-object=111 /tmp/af8_filled.pdf          # Appearance stream (compressed)
qpdf --show-object=111 --filtered-stream-data /tmp/af8_filled.pdf  # Decompressed appearance

# Check AcroForm structure
qpdf --show-object=1024 /tmp/af8_filled.pdf         # Document catalog
qpdf --show-object=1025 /tmp/af8_filled.pdf         # AcroForm dictionary

# Verify field hierarchy
qpdf --show-object=244 /tmp/af8_filled.pdf          # Root form field
qpdf --show-object=245 /tmp/af8_filled.pdf          # Page1[0]
qpdf --show-object=246 /tmp/af8_filled.pdf          # P[0]
```
